name: Release

permissions:
  pull-requests: write
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release-pr:
    name: Create release PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install release-plz
        run: |
          curl -sSL https://github.com/release-plz/release-plz/releases/latest/download/release-plz-x86_64-unknown-linux-gnu.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Checkout latest tag for comparison
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            git worktree add /tmp/latest-release "$LATEST_TAG"
            echo "REGISTRY_MANIFEST_PATH=/tmp/latest-release/Cargo.toml" >> "$GITHUB_ENV"
          fi

      - name: Run release-plz release-pr
        run: |
          if [ -n "$REGISTRY_MANIFEST_PATH" ]; then
            release-plz release-pr --git-token "$GITHUB_TOKEN" --registry-manifest-path "$REGISTRY_MANIFEST_PATH"
          else
            release-plz release-pr --git-token "$GITHUB_TOKEN"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install release-plz
        run: |
          curl -sSL https://github.com/release-plz/release-plz/releases/latest/download/release-plz-x86_64-unknown-linux-gnu.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Run release-plz release
        run: release-plz release --git-token "$GITHUB_TOKEN"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
